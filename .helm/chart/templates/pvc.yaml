{{- range $storage := .Values.storages }}
{{- $pvc := $storage.pvc | default dict }}
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ include "matchd-backend.fullname" $ }}-{{ $storage.name }}
  labels:
    app.kubernetes.io/name: {{ template "matchd-backend.name" $ }}
    app.kubernetes.io/managed-by: {{ $.Release.Service }}
    app.kubernetes.io/instance: {{ $.Release.Name }}
    app.kubernetes.io/version: {{ template "matchd-backend.version" $ }}
    app.joshmartin.ch/environment: {{ template "matchd-backend.environment" $ }}
    helm.sh/chart: {{ template "matchd-backend.chart" $ }}
  annotations:
{{- if $pvc.defaultBucketName }}
    gcs.csi.ofek.dev/bucket: {{ printf "%s-%s-%s" $.Release.Namespace (include "matchd-backend.fullname" $) $storage.name | trunc 63 | trimSuffix "-" }}
{{- end }}
    {{- range $key, $value := $pvc.annotations }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
spec:
  storageClassName: {{ $pvc.storageClassName | default "csi-gcs" }}
  accessModes:
    - ReadWriteMany
  resources:
    requests:
      storage: {{ $pvc.size | default "10Gi" }}
{{- end }}
